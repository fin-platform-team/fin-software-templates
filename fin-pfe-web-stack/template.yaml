apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: fin-pfe-web-stackv2
  title: Fin Web Stack
  description: |
    Creates Fin's Opinionated Web Stack
  tags:
    - eks
    - fin-web
    - aws
    - infrastructure
spec:
  owner: group:default/fin-platform-engineering
  type: service

  parameters:
    - title: Fill in Stack requirements
      required:
        - name
      properties:
        name:
          title: Name
          type: string
          description: Unique name of the component
          ui:autofocus: true
          ui:options:
            rows: 5
    # - title: Choose a location
    #   required:
    #     - repoUrl
    #   properties:
    #     repoUrl:
    #       title: Repository Location
    #       type: string
    #       ui:field: RepoUrlPicker
    #       ui:options:
    #         allowedHosts:
    #           - github.com

  steps:
    # - id: fetch-base
    #   name: Fetch Base
    #   action: fetch:template
    #   input:
    #     url: ./content
    #     values:
    #       name: fin-pfe-${{ parameters.name }}-web-stack

    # - id: publish
    #   name: Publish
    #   action: publish:github
    #   input:
    #     description: This is Fin ${{ parameters.name }} web stack
    #     repoUrl: ${{ parameters.repoUrl }}
    #     defaultBranch: main
    #     repoVisibility: public

    - id: fetch-argo-base
      name: Fetch Argo Base
      action: fetch:template
      input:
        url: ./content/argocd
        values:
          name: ${{ parameters.name }}

    - id: rename-claim-file
      name: Rename Claim File
      action: fs:rename
      input:
        files:
          - from: ./application.yaml
            to: "${{ parameters.name }}-claim.yaml"
    
    - id: publish-argo-app
      name: PublishArgoApp
      action: publish:github:pull-request
      input:
        description: "This is Fin ${{ parameters.name }} web stack ArgoCD Application"
        commitMessage: "Claim submitted for ${{ parameters.name }} from Backstage"
        repoUrl: "github.com?repo=fin-catalog-claims&owner=fin-platform-team"
        branchName: ${{ parameters.name }}
        title: "${{ parameters.name }} - Claim"
        targetBranchName: "main"
        targetPath: "./argocd"

    # - id: register
    #   name: Register
    #   action: catalog:register
    #   input:
    #     repoContentsUrl: ${{ steps['publish'].output.repoContentsUrl }}
    #     catalogInfoPath: /catalog-info.yaml

  output:
    links:
      # - title: Claim Repository
      #   url: ${{ steps['publish'].output.remoteUrl }}
      - title: Argo App Repository
        url: ${{ steps['publish-argo-app'].output.remoteUrl }}
      # - title: Open in catalog
      #   icon: catalog
      #   entityRef: ${{ steps['register'].output.entityRef }}
