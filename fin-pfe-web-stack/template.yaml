apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: fin-pfe-web-stackv2
  title: Fin - AWS - Webapp Stack
  description: |
    Creates Fin's Opinionated Web Application Stack on AWS
  tags:
    - eks
    - fin-web
    - aws
    - infrastructure
spec:
  owner: group:default/fin-platform-engineering
  type: service

  parameters:
    - title: Fill in Stack requirements
      required:
        - name
      properties:
        name:
          title: Name
          type: string
          description: Unique name of the component
          ui:autofocus: true
          ui:options:
            rows: 5
    # - title: Choose a location
    #   required:
    #     - repoUrl
    #   properties:
    #     repoUrl:
    #       title: Repository Location
    #       type: string
    #       ui:field: RepoUrlPicker
    #       ui:options:
    #         allowedHosts:
    #           - github.com

  steps:
    - id: fetch-claim-base
      name: Fetch Claim Base
      action: fetch:template
      input:
        url: ./content/claims
        values:
          name: ${{ parameters.name }}

    - id: rename-claim-file
      name: Rename Claim File
      action: fs:rename
      input:
        files:
          - from: ./webstack.yaml
            to: "${{ parameters.name }}-claim.yaml"

    - id: publish-claim-file
      name: PublishClaims
      action: publish:github:pull-request
      input:
        description: "This is Fin ${{ parameters.name }} web stack claim"
        repoUrl: "github.com?repo=fin-catalog-claims&owner=fin-platform-team"
        branchName: ${{ parameters.name }}
        title: "${{ parameters.name }} - Claim"
        targetBranchName: "main"
        targetPath: "./claims/${{ parameters.name }}"

    - id: fetch-argo-base
      name: Fetch Argo Base
      action: fetch:template
      input:
        url: ./content/argocd
        values:
          name: ${{ parameters.name }}

    - action: fs:delete
      id: deleteFiles
      name: Delete files
      input:
        files:
          - "./claims/${{ parameters.name }}/${{ parameters.name }}-claim.yaml"

    - id: rename-claim-argo-file
      name: Rename Claim Argo File
      action: fs:rename
      input:
        files:
          - from: ./application.yaml
            to: "${{ parameters.name }}-claim-argo-app.yaml"
    
    - id: publish-argo-app-file
      name: PublishArgoApp
      action: publish:github:pull-request
      input:
        description: "This is Fin ${{ parameters.name }} web stack ArgoCD Application"
        commitMessage: "Claim submitted for ${{ parameters.name }} from Backstage"
        repoUrl: "github.com?repo=fin-claims-aoa&owner=fin-platform-team"
        branchName: ${{ parameters.name }}
        title: "${{ parameters.name }} - Claim Argo App"
        targetBranchName: "main"
        targetPath: "./claims/${{ parameters.name }}"

    - id: register
      name: Register
      action: catalog:register
      input:
        # repoContentsUrl: ${{ steps['publish'].output.repoContentsUrl }}
        # catalogInfoPath: /catalog-info.yaml
        catalogInfoUrl: "https://github.com/fin-platform-team/fin-catalog-claims/blob/main/claims/${{ parameters.name }}/catalog-info.yaml"

  output:
    links:
      # - title: Claim Repository
      #   url: ${{ steps['publish'].output.remoteUrl }}
      - title: Argo App Repository
        url: ${{ steps['publish-argo-app-file'].output.remoteUrl }}
      - title: Claim App Repository
        url: ${{ steps['publish-claim-file'].output.remoteUrl }}   
      # - title: Open in catalog
      #   icon: catalog
      #   entityRef: ${{ steps['register'].output.entityRef }}
